# GitLab CI/CD Pipeline for DevOps Practices MCP Server
#
# Branching Strategy: GitLab Flow
# - main: Production releases (tagged with semantic versions)
# - develop: Active development, integration branch
# - feature/*: New features, merge to develop
# - release/*: Version preparation, merge to main + develop
# - hotfix/*: Critical fixes, merge to main + develop
#
# Pipeline runs on:
# - All merge requests (validates before merge)
# - main branch (production validation)
# - develop branch (integration validation)
# - feature/*, release/*, hotfix/* branches (development validation)

stages:
  - validate
  - test
  - release

# Health Check Job
health-check:
  stage: validate
  image: python:3.10-slim
  before_script:
    - echo "üîç Starting MCP Server Health Check"
    - python --version
    - pip --version
  script:
    - bash health-check.sh
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH =~ /^feature\/.*/'
    - if: '$CI_COMMIT_BRANCH =~ /^release\/.*/'
    - if: '$CI_COMMIT_BRANCH =~ /^hotfix\/.*/'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH =~ /^feature\/.*/'
    - if: '$CI_COMMIT_BRANCH =~ /^release\/.*/'
    - if: '$CI_COMMIT_BRANCH =~ /^hotfix\/.*/'
  artifacts:
    when: on_failure
    paths:
      - health-check.log
    expire_in: 1 week

# Python Environment Validation
python-validation:
  stage: validate
  image: python:3.10-slim
  before_script:
    - pip install -r requirements.txt
  script:
    - echo "‚úÖ Validating Python environment"
    - python -c "import json; import logging; import sys; from pathlib import Path; print('All imports successful')"
    - python -m py_compile mcp-server.py
    - echo "‚úÖ Python syntax validation passed"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH =~ /^feature\/.*/'
    - if: '$CI_COMMIT_BRANCH =~ /^release\/.*/'
    - if: '$CI_COMMIT_BRANCH =~ /^hotfix\/.*/'

# Practice File Validation
practice-validation:
  stage: test
  image: python:3.10-slim
  script:
    - echo "üìù Validating practice files"
    - |
      # Check all practice files are valid markdown
      for file in practices/*.md; do
        if [ ! -f "$file" ]; then
          echo "‚ùå Practice file not found: $file"
          exit 1
        fi
        echo "‚úÖ Found: $file"
      done
    - echo "‚úÖ All practice files validated"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH =~ /^feature\/.*/'
    - if: '$CI_COMMIT_BRANCH =~ /^release\/.*/'
    - if: '$CI_COMMIT_BRANCH =~ /^hotfix\/.*/'

# Template File Validation
template-validation:
  stage: test
  image: python:3.10-slim
  script:
    - echo "üìã Validating template files"
    - |
      # Check all template files exist and contain variables
      for file in templates/*.md; do
        if [ ! -f "$file" ]; then
          echo "‚ùå Template file not found: $file"
          exit 1
        fi
        # Check if template contains at least one variable placeholder
        if ! grep -q '\${' "$file"; then
          echo "‚ö†Ô∏è  Warning: Template may not contain variable placeholders: $file"
        fi
        echo "‚úÖ Found: $file"
      done
    - echo "‚úÖ All template files validated"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH =~ /^feature\/.*/'
    - if: '$CI_COMMIT_BRANCH =~ /^release\/.*/'
    - if: '$CI_COMMIT_BRANCH =~ /^hotfix\/.*/'

# Documentation Link Checker
link-checker:
  stage: test
  image: python:3.10-slim
  script:
    - echo "üîó Checking documentation links"
    - |
      # Check for broken internal links in README
      if ! grep -l 'practices/' README.md; then
        echo "‚ö†Ô∏è  Warning: README may not reference practices"
      fi
      if ! grep -l 'templates/' README.md; then
        echo "‚ö†Ô∏è  Warning: README may not reference templates"
      fi
    - echo "‚úÖ Documentation link check complete"
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH =~ /^feature\/.*/'
    - if: '$CI_COMMIT_BRANCH =~ /^release\/.*/'
    - if: '$CI_COMMIT_BRANCH =~ /^hotfix\/.*/'

# Release Validation (for release/* and hotfix/* branches)
release-validation:
  stage: release
  image: python:3.10-slim
  script:
    - echo "üöÄ Validating release preparation"
    - |
      # Check CHANGELOG.md was updated
      if ! grep -q "$CI_COMMIT_BRANCH" CHANGELOG.md; then
        echo "‚ö†Ô∏è  Warning: CHANGELOG.md may not be updated for this release"
      fi
    - |
      # Extract version from branch name (e.g., release/v1.2.0 -> v1.2.0)
      if [[ "$CI_COMMIT_BRANCH" =~ ^release/v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
        VERSION="${BASH_REMATCH[1]}"
        echo "‚úÖ Valid semantic version: v$VERSION"
      elif [[ "$CI_COMMIT_BRANCH" =~ ^hotfix/ ]]; then
        echo "‚úÖ Hotfix branch detected"
      else
        echo "‚ö†Ô∏è  Warning: Branch name doesn't follow semver pattern"
      fi
    - echo "‚úÖ Release validation complete"
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^release\/.*/'
    - if: '$CI_COMMIT_BRANCH =~ /^hotfix\/.*/'

# Branch Protection Reminder (informational only)
branch-protection-check:
  stage: release
  image: alpine:latest
  script:
    - echo "‚ÑπÔ∏è  Branch Protection Recommendations:"
    - echo "  - main: Require MR, require CI passing, require 1+ approval, block force push"
    - echo "  - develop: Require MR, require CI passing, block force push"
    - echo "  - feature/*, release/*, hotfix/*: No restrictions (allow force push)"
    - echo ""
    - echo "üìã Current branch: $CI_COMMIT_BRANCH"
    - |
      if [[ "$CI_COMMIT_BRANCH" == "main" ]] || [[ "$CI_COMMIT_BRANCH" == "develop" ]]; then
        echo "‚ö†Ô∏è  CRITICAL: Ensure this branch has protection rules enabled in GitLab!"
      fi
  allow_failure: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
